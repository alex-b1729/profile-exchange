{% extends "base.html" %}
{% load thumbnail %}
{% load static %}

{% block title %}Profile{% endblock %}

{% block content %}
  <div class="content-header">
    <h1>Profile</h1>
    {% if entity == "self" %}<a href="{% url "edit" %}">Edit</a>{% endif %}
    {% if entity == "connection" %}<a href="{% url "edit_connection" connection.id %}">Edit</a>{% endif %}
  </div>

  {% with vcard_linked=connection.profile.user.vcard %}
  <div class="profile">
    {% thumbnail vcard.photo "200x200" crop="center" as im %}
    <img id="PHOTO" class="profilePhoto" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" alt="{{ vcard.FN }} profile photo">
    {% empty %}
    <div class="profilePhoto container large">{{ vcard.first_name|slice:"1" }}{{ vcard.last_name|slice:"1" }}</div>
    {% endthumbnail %}

    <div class="text-container">
      <p id="FN">
        {{ vcard.FN }}
        {% if entity == "connection" and connection.profile %} âœ…{% endif %}
      </p>
      {% if entity == "connection" %}
      {% if connection.profile %}<a href="#">Manage linked card</a>
      {% else %}<a href="#">Link card</a>
      {% endif %}
      {% endif %}

      {% with nickname=vcard.nickname %}
      {% with nickname_linked=vcard_linked.nickname %}
      {% if nickname or nickname_linked %}
      <div id="NICKNAME">
        {% if nickname %}<p>"{{ nickname }}"</p>{% endif %}
        {% if nickname_linked %}<p class="linked">"{{ nickname_linked }}"</p>{% endif %}
      </div>
      {% endif %}
      {% endwith %}
      {% endwith %}

      {% with headline=profile.headline %}
      {% if headline %}
      <p id="headline">{{ headline }}</p>
      {% endif %}
      {% endwith %}
      {% with location=profile.location %}
      {% if location %}
      <p id="location">{{ location }}</p>
      {% endif %}
      {% endwith %}
      {% with description=profile.description %}
      {% if description %}
      <p id="description">{{ description }}</p>
      {% endif %}
      {% endwith %}
    </div>
  </div>

  <div class="vcard">
    <h2>Contact Info</h2>
    <!-- todo: gotta download linked content -->
    {% if entity == "self" %}<a href="{% url "download_vcard" %}">Download</a>{% endif %}
    {% if entity == "connection" %}<a href="{% url "download_connection_vcard" connection.id %}">Download</a>{% endif %}
    <p><i>{{ user.vcard.get_kind_display }}</i></p>

    {% with phones=vcard.phone_set.all phones_linked=vcard_linked.phone_set.all %}
    {% if phones or phones_linked %}
    <div class="vcardGroup">
      <h3>Phone</h3>
      <div id="TEL">
        <ul>
          {% for phone in phones %}
          <!-- todo: does phone.phone_type return the key or value? -->
          <li class="{{ phone.phone_type }}">{{ phone.get_phone_type_display }}: {{ phone.phone_number }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
    {% endwith %}
    
    {% with emails=connection.email_set_full %}
    {% if emails %}
    <div class="vcardGroup">
      <h3>Email</h3>
      <div id="EMAIL">
        <ul>
          {% for email in emails %}
          <li{% if email.linked %} class="linked"{% endif %}>{{ email.get_email_type_display }}: <a href="mailto:{{ email.email_address }}" class="{{ email.email_type }} INTERNET">{{ email.email_address }}</a></li>
          <!-- TODO: protect mailto links -->
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
    {% endwith %}

    {% with urls=vcard.url_set.all %}
    {% if urls %}
    <div class="vcardGroup">
      <h3>URLs</h3>
      <div id="URL">
        <ul>
          {% for url in urls %}
          <li>{{ url.get_url_type_display }}: <a href="{{ url.url }}" class="{{ url.url_type }}">{{ url.url }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
    {% endwith %}

    {% with addresses=vcard.address_set.all %}
    {% if addresses %}
    <div class="vcardGroup">
      <h3>Addresses</h3>
      <div id="ADR">
        <ul>
          {% for address in addresses %}
          <li>
            <div class="{{ address.address_type }}">
              <p class="addressType">{{ address.get_address_type_display }}</p>
              <p class="adrLine1">{{ address.street1 }}</p>
              <p class="adrLine2">{{ address.street2 }}</p>
              <p class="adrLine3">{{ address.city }}, {{ address.state }} {{ address.zip }}</p>
              <p class="country">{{ address.country }}</p>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
    {% endwith %}

    <!-- todo: add org logo -->
    {% with orgs=vcard.organization_set.all %}
    {% if orgs %}
    <div class="vcardGroup">
      <h3>Organizations</h3>
      <div id="ORG">
        <ul>
          {% for org in orgs %}
          <li>
            <p><span id="TITLE">{{ org.title }}</span> * <span id="ORG">{{ org.organization }}</span>
            <p><span id="ROLE">{{ org.role }}</span></p>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
    {% endwith %}


    {% with bday=vcard.birthday %}
    {% with anniv=vcard.anniversary %}
    {% with sex=vcard.sex %}
    {% with gender=vcard.gender %}
    {% if bday or anniv or sex or gender != "" %}
    <div class="vcardGroup">
      <h3>Personal</h3>
      <div class="text-container">
        <ul>
          {% if bday %}
          {% with bdayy=vcard.birthday_year %}
          <li id="BDAY">Birthday: {{ bday }}{% if bdayy %}, {{ bdayy }}{% endif %}</li>
          {% endwith %}
          {% endif %}
          {% if anniv %}
          {% with annivy=vcard.anniversary_year %}
          <li id="ANNIVERARY">Anniversary: {{ anniv }}{% if annivy %}, {{ annivy }}{% endif %}</li>
          {% endwith %}
          {% endif %}
          {% if sex and sex != "" or gender != "" %}
          <li id="gender">{% if sex and sex != "" %}{{ sex }} - {% endif %}{% if gender != "" %}{{ gender }}{% endif %}</li>
          {% endif %}
        </ul>
      </div>
    </div>
    {% endif %}
    {% endwith %}
    {% endwith %}
    {% endwith %}
    {% endwith %}

    {% with tags=vcard.tag_set.all %}
    {% if tags %}
    <div class="vcardGroup">
      <h3>Tags</h3>
      <div id="#CATEGORIES">
        <ul>
          {% for tag in tags %}
          <li><a href="#" class="{{ tag.tag }}">{{ tag.tag }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
    {% endwith %}

    {% with note=vcard.note %}
    {% if note %}
    <div class="vcardGroup">
      <h3>Note</h3>
      <div class="text-container">
        {% if note %}
        <p>{{ note }}</p>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% endwith %}

  </div>
  {% endwith %}
{% endblock %}